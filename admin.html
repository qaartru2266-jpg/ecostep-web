<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EcoStep Admin</title>
  <style>
    :root {
      --bg1: #f4fbff;
      --bg2: #dbeeff;
      --card: #ffffff;
      --line: #d5e6f5;
      --text: #17324a;
      --accent: #0b74c9;
      --ok: #198754;
      --err: #c62828;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
      color: var(--text);
      background: linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height: 100vh;
      padding: 24px;
      box-sizing: border-box;
    }

    .wrap {
      max-width: 860px;
      margin: 0 auto;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(11, 116, 201, 0.12);
      padding: 20px;
    }

    h1 {
      margin: 0 0 16px;
      font-size: 22px;
    }

    .row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
    }

    input, button {
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #b8cfe6;
      font-size: 14px;
      box-sizing: border-box;
    }

    input { background: #fff; }
    button {
      background: var(--accent);
      color: #fff;
      border: none;
      cursor: pointer;
    }

    button.secondary {
      background: #6c7a86;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }

    th, td {
      border-bottom: 1px solid var(--line);
      padding: 10px 8px;
      text-align: left;
    }

    .hidden { display: none; }
    .msg { margin-top: 8px; font-size: 13px; }
    .ok { color: var(--ok); }
    .err { color: var(--err); }
    .small { font-size: 12px; color: #52687a; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>EcoStep 数据后台</h1>

    <div id="login-panel">
      <div class="row">
        <input id="admin-password" type="password" placeholder="管理员密码">
        <button id="btn-login" type="button">登录</button>
      </div>
      <div id="login-msg" class="msg"></div>
      <div class="small">登录后可修改家庭编号对应的激活码和证书鱼数量。</div>
    </div>

    <div id="data-panel" class="hidden">
      <div class="row">
        <button id="btn-reload" type="button">刷新数据</button>
        <button id="btn-logout" type="button" class="secondary">退出登录</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>家庭编号</th>
            <th>激活码</th>
            <th>证书鱼数量</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="family-table"></tbody>
      </table>
      <div id="data-msg" class="msg"></div>
    </div>
  </div>

  <script>
    function setMsg(el, text, isError) {
      el.className = 'msg ' + (isError ? 'err' : 'ok');
      el.textContent = text;
    }

    async function request(url, options) {
      const resp = await fetch(url, {
        headers: { 'Content-Type': 'application/json' },
        ...options
      });
      const data = await resp.json().catch(() => ({}));
      if (!resp.ok || data.ok === false) {
        throw new Error(data.message || '请求失败');
      }
      return data;
    }

    function togglePanel(isAdmin) {
      document.getElementById('login-panel').classList.toggle('hidden', isAdmin);
      document.getElementById('data-panel').classList.toggle('hidden', !isAdmin);
    }

    function buildRows(data) {
      const tbody = document.getElementById('family-table');
      tbody.innerHTML = '';
      const ids = Object.keys(data).sort();
      for (const id of ids) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${id}</td>
          <td><input data-id="${id}" data-field="code" value="${data[id].code}"></td>
          <td><input data-id="${id}" data-field="fishCount" type="number" min="0" step="1" value="${data[id].fishCount}"></td>
          <td><button data-id="${id}">保存</button></td>
        `;
        tbody.appendChild(tr);
      }

      tbody.querySelectorAll('button[data-id]').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');
          const code = tbody.querySelector(`input[data-id="${id}"][data-field="code"]`).value.trim();
          const fishCount = Number(tbody.querySelector(`input[data-id="${id}"][data-field="fishCount"]`).value);
          const msgEl = document.getElementById('data-msg');
          try {
            await request(`/api/admin/families/${id}`, {
              method: 'PUT',
              body: JSON.stringify({ code, fishCount })
            });
            setMsg(msgEl, `${id} 保存成功`, false);
          } catch (err) {
            setMsg(msgEl, `${id} 保存失败: ${err.message}`, true);
          }
        });
      });
    }

    async function loadData() {
      const msgEl = document.getElementById('data-msg');
      try {
        const res = await request('/api/admin/families');
        buildRows(res.data || {});
        setMsg(msgEl, '数据已加载', false);
      } catch (err) {
        setMsg(msgEl, err.message, true);
      }
    }

    document.getElementById('btn-login').addEventListener('click', async () => {
      const password = document.getElementById('admin-password').value;
      const msgEl = document.getElementById('login-msg');
      try {
        await request('/api/admin/login', {
          method: 'POST',
          body: JSON.stringify({ password })
        });
        togglePanel(true);
        await loadData();
      } catch (err) {
        setMsg(msgEl, err.message, true);
      }
    });

    document.getElementById('btn-reload').addEventListener('click', loadData);

    document.getElementById('btn-logout').addEventListener('click', async () => {
      await request('/api/admin/logout', { method: 'POST', body: '{}' });
      togglePanel(false);
      document.getElementById('data-msg').textContent = '';
    });

    (async function init() {
      try {
        const session = await request('/api/admin/session');
        if (session.isAdmin) {
          togglePanel(true);
          await loadData();
        }
      } catch (_err) {
        togglePanel(false);
      }
    })();
  </script>
</body>
</html>
